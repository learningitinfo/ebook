<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="js/jquery.min.js"></script>
</head>
<body>
<!--购买的商品信息-->
<div>
    <h3>商品信息</h3>
    <table id="goodslist" border="1px;">
        <tr>
            <th>图片</th>
            <th>商品名称</th>
            <th>单价</th>
            <th>数量</th>
            <th>小计</th>
        </tr>
    </table>
</div>
<!--收货地址-->
<div>
    <h3>收货地址</h3>
    <table border="1px" id="address">

    </table>
</div>
<!--总金额、下单按钮-->
<div>
    <p>
        <span>应付总金额:</span><span id="total"></span>
    </p>
    <button onclick="makeorder()">确认无误,提交订单</button>
</div>

<script>
    //得到购物车的id
    let ids = window.location.href.split("=")[1];
    console.log(ids);

    /*下订单*/
    function makeorder(){
        //提交购物车id、地址id
        //通过类选择器找到所有的单选框
        let aid = 0;
        let addrs = $(".address");
        for(let addr of addrs){
            let address = $(addr);
            if (address.prop("checked")){
                aid = address.prop("id");
                break;
            }
        }
        console.log(aid);
        //发请求、提交数据
        $.ajax({
            url:'order/make',
            data:{
                'ids':ids,
                'aid':aid
            },
            success:function (res) {
                console.log(res);
                //当数据量比较大时，页面之间的传参通过sessionstorage实现
                //sessionstorage是浏览器自带的对象，里面可以存储临时的数据，这些数据可以在各个页面之间共享
                //只要浏览器关闭，这些数据就会被清除掉
                //注意：sessionstorage存储数据时是以字符串的形式存储，如果要向里面存放对象，需要先将对象转换成json格式
                //的字符串
                let data = JSON.stringify(res.data);
                //存入sessionstorage
                window.sessionStorage.setItem("orderdto",data);

                //跳转到支付页面
                window.location.href = 'pay.html';
            }
        });
    }




    //1.提交ids，通过ids查出对应的商品信息
    $.ajax({
        url: "cart/byids",
        data:{
            "ids":ids  //1,2,3,4
        },
        success:function (res) {
            console.log(res);
            if (res.status = 'REQUEST_SUCCESS'){
                //总金额
                let total = 0;
                for(let cart of res.data){
                    let image_td = $("<td></td>");
                    let image = $("<img width='50px' height='50px'>").prop("src",cart.goods.image);
                    //将图片放到td
                    image_td.append(image);

                    //名称
                    let name_td = $("<td width='40%'></td>").text(cart.goods.name);
                    //单价
                    let price_td = $("<td></td>").text(cart.goods.salesprice);
                    //数量
                    let nums_td = $("<td></td>").text(cart.nums);
                    //小计
                    let sm_total = $("<td></td>").text(cart.nums * cart.goods.salesprice);
                    //总金额
                    total = total + cart.nums * cart.goods.salesprice;

                    //创建tr
                    let tr = $("<tr></tr>");

                    //将td放到tr上
                    tr.append(image_td);
                    tr.append(name_td);
                    tr.append(price_td);
                    tr.append(nums_td);
                    tr.append(sm_total);

                    //将tr放到表格上
                    $("#goodslist").append(tr);
                }
                //设置总金额
                total = total.toFixed(1);   //处理精度
                $("#total").text(total);
            }
        }
    });
    //2.发送请求获取当前用户的收货地址
    $.ajax({
        url:'address/info',
        success:function (res) {
            console.log(res);
            for (let item of res.data){
                //创建行
                let tr = $("<tr></tr>");
                //td
                let check_td = $("<td></td>");
                let radio = $("<input type='radio' name='check_address' class='address'>").prop("id",item.id);
                if (item.type == 'y'){
                    //默认
                    radio.prop("checked",true);
                }
                check_td.append(radio);

                //收货人
                let accept = $("<td></td>").text(item.accept);
                //手机号
                let telphone = $("<td></td>").text(item.telphone);
                //地址
                let address_td = $("<td></td>").text(item.province+item.city+item.area+item.address);

                //将td放到tr上
                tr.append(check_td);
                tr.append(accept);
                tr.append(telphone);
                tr.append(address_td);

                //将tr放到table上
                $("#address").append(tr);
            }
        }
    });

</script>
</body>
</html>